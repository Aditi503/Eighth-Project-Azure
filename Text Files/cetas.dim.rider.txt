-- 1. Drop the table if it already exists to allow for a clean recreate
IF OBJECT_ID('dbo.dim_rider') IS NOT NULL
    DROP EXTERNAL TABLE [dbo].[dim_rider];
GO

-- 2. Create the External Table (CETAS)
CREATE EXTERNAL TABLE dbo.dim_rider
WITH (
    LOCATION    = 'star_schema/dim_rider',
    DATA_SOURCE = [eighthprojectfilesystem_eighthprojectaccount_dfs_core_windows_net],
    FILE_FORMAT = [SynapseDelimitedTextFormat]
)  
AS
SELECT 
    [rider_id] AS [rider_key], 
    [first_name],
	[last_name],
    [address],
    CAST([birthday] AS DATE) AS [birthday],
    CAST([is_member] AS BIT) AS [is_member]
FROM OPENROWSET(
    BULK 'Staging_Rider.csv', 
    DATA_SOURCE = 'eighthprojectfilesystem_eighthprojectaccount_dfs_core_windows_net',
    FORMAT = 'CSV',
    PARSER_VERSION = '2.0',
    FIRSTROW = 2
) 
WITH (
    [rider_id] INT,
    [first_name] VARCHAR(50) COLLATE Latin1_General_100_BIN2_UTF8,
    [last_name] VARCHAR(50) COLLATE Latin1_General_100_BIN2_UTF8,
    [address] VARCHAR(100) COLLATE Latin1_General_100_BIN2_UTF8,
    [birthday] VARCHAR(50) COLLATE Latin1_General_100_BIN2_UTF8,
    [account_start_date] VARCHAR(50) COLLATE Latin1_General_100_BIN2_UTF8,
    [account_end_date] VARCHAR(50) COLLATE Latin1_General_100_BIN2_UTF8,
    [is_member] BIT
) AS [riders];
GO

-- 3. Return the first 50 rows to verify the transformation
SELECT TOP 50 * FROM dbo.dim_rider;